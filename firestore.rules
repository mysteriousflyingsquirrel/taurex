rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ─── Helpers ───────────────────────────────────────────
    function isSignedIn() {
      return request.auth != null;
    }

    function isApex() {
      return isSignedIn() && request.auth.token.admin == true;
    }

    function isHostOwner(hostId) {
      return isSignedIn()
          && exists(/databases/$(database)/documents/users/$(request.auth.uid))
          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.hostId == hostId;
    }

    function hasNoSensitiveCalendarFields() {
      return !("calendar" in request.resource.data)
          || (
            !("exportToken" in request.resource.data.calendar)
            && !("imports" in request.resource.data.calendar)
          );
    }

    // ─── Users collection ──────────────────────────────────
    match /users/{uid} {
      allow read: if isApex() || (isSignedIn() && request.auth.uid == uid);
      allow write: if isApex();
    }

    // ─── Hosts collection ──────────────────────────────────
    match /hosts/{hostId} {
      allow read: if true;
      allow create, delete: if isApex();
      allow update: if isApex() || isHostOwner(hostId);

      // ─── Apartments subcollection ──────────────────────
      match /apartments/{apartmentId} {
        // Public read (booking app needs this for apartment listing/detail)
        allow read: if true;
        // Host owner or apex can write, but public apartment docs must not store sensitive calendar internals
        allow write: if (isApex() || isHostOwner(hostId)) && hasNoSensitiveCalendarFields();
      }

      // ─── Seasons subcollection ─────────────────────────
      match /seasons/{seasonId} {
        // Public read (booking app needs this for pricing display)
        allow read: if true;
        // Host owner or apex can write
        allow write: if isApex() || isHostOwner(hostId);
      }

      // ─── Private apartment calendar internals ─────────
      match /apartmentCalendarsPrivate/{apartmentSlug} {
        allow read, write: if isApex() || isHostOwner(hostId);
      }

      // ─── Catch-all for future subcollections ───────────
      match /{subcollection}/{docId} {
        allow read: if isApex() || isHostOwner(hostId);
        allow write: if isApex() || isHostOwner(hostId);
      }
    }
  }
}
